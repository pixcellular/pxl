<!doctype html>

<html lang="en">
  <head>
    <title>Plan javascript pixcellular example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>

        #grid {
            display: inline-block;
            border: 1px solid black;
            line-height: 0.6em;
        }

    </style>
  </head>
  <body>
    <pre id="grid"></pre>
    <script src="https://unpkg.com/pixcellular@1.1.19/index.js"></script>
    <script>

        const map = [
            '     ',
            '     ',
            '  o  ',
            '     ',
            '     ',
        ];

        // Turn map into entities:
        const entityFactory = new pxl.EntityFactory();
        const space = {symbol: ' '};
        entityFactory.add(' ', () => space);
        entityFactory.add('o', (props) => { return {symbol: 'o', handled: false, props}});

        // Define properties of entity:
        const organismProps = {location: new pxl.Vector(2, 2), age: 0, energy: 50};
        const entityProps = [organismProps];

        // Define behaviour:
        const entityHandler = new pxl.EntityHandlerMap()
        entityHandler.add(' ', {handle: () => null});
        entityHandler.add('o', {
            handle: (organism, location, world) => {
                // Get neighbours:
                const view = new pxl.View(world, location);

                // Find random empty space:
                const direction = view.find(' ');
                const destination = location.plus(direction.toVector());

                // Move:
                world.getGrid().set(location, space);
                world.getGrid().set(destination, organism);

                // Update props:
                organism.props.age ++;
                organism.props.energy --;

                if(organism.props.energy <= 0) {
                    // Die:
                    world.getGrid().set(destination, space);
                }
            }
        });

        const world = new pxl.World(map, entityFactory, entityProps, entityHandler)

        const interval = setInterval(() => {
            document.getElementById('grid').innerText = world.turn().toString();
            console.log(`age=${organismProps.age}; energy=${organismProps.energy}`);
            if(organismProps.energy <= 0) {
                clearInterval(interval);
            }
        }, 100);

    </script>
  </body>
</html>
