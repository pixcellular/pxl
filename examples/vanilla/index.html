<!doctype html>

<html lang="en">
  <head>
    <title>Plain javascript pixcellular example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>

      #grid {
        display: inline-block;
        border: 1px solid black;
        line-height: 0.6em;
      }

    </style>
  </head>
  <body>
    <pre id="grid"></pre>
    <script data-search-needle="pxl-dependency" src="https://unpkg.com/pixcellular@2.3.1/index.js"></script>
    <script>

      const map = [
        'o  ',
        ' o ',
        '   '
      ];
      const space = {};
      const organisms = [
        {location: new pxl.Vector(0, 0), energy: 10},
        {location: new pxl.Vector(1, 1), energy: 20}
      ];

      const builders = new pxl.EntityBuilderMap();
      // Space stays space:
      builders.add(' ', {build: (props) => ({symbol: ' ', space})});
      // Every entity can have its own props:
      builders.add('o', {build: (props) => ({symbol: 'o', props})});

      const handlers = new pxl.EntityHandlerMap()
      // Space does nothing:
      handlers.add(' ', {handle: () => {}});
      // Organisms behave according to specific rules:
      handlers.add('o', {
        handle: (organism, location, world) => {
          // Living costs energy:
          organism.props.energy--;

          // Get current and neighbouring cells:
          const view = new pxl.Neighbours(world, location);

          // No energy means death:
          if (organism.props.energy <= 0) {
            view.remove(pxl.ZERO);
            return;
          }

          // Find random empty space:
          const spaceFound = view.findDirRand(e => e.symbol === ' ');

          if(spaceFound) {
            // Move randomly:
            view.put(spaceFound, organism);
            return;
          }

        }
      });

      const world = new pxl.World({map, entityProps: organisms, builders, handlers})

      const interval = setInterval(() => {
        document.getElementById('grid').innerText = world.turn().toString();
        console.log('turn', world.age, 'organisms', JSON.stringify(organisms))
        if (!organisms.find(o => o.energy > 0)) {
          clearInterval(interval);
        }
      }, 250);

    </script>
  </body>
</html>
